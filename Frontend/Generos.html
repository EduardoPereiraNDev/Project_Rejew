<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="author" content="Peras">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Generos</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="CSS/Generos.css">
</head>

<body>
    <div class="container mt-5">
        <!-- Categorias -->
        <ul class="nav nav-tabs" id="myTabs">
            <li class="nav-item">
                <a class="nav-link active" id="lista-tab" data-toggle="tab" href="#lista">Lista</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="cadastro-tab" data-toggle="tab" href="#cadastro">Cadastro</a>
            </li>
        </ul>

        <!-- Categorias2 -->
        <div class="tab-content mt-2">
            <!-- Aba Lista -->
            <div class="tab-pane active" id="lista">
                <h4>Lista de Generos</h4>
                <input type="text" id="pesquisa" placeholder="Pesquisar.....">
                <button class="btn btn-success" id="buttonPesquisar">Pesquisar</button>
                <button class="btn btn-danger" id="buttonApagar">Apagar</button>
                <table class="table table-bordered" id="tabela_lista">
                    <thead>
                        <tr>
                            <th>ID Genero</th>
                            <th>Genero Nome</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <!-- Aba Cadastro -->
            <div class="tab-pane" id="cadastro">
                <h4>Cadastrar Genero</h4>
                <form id="form_cadastro">
                    <div class="form-group">
                        <label for="GeneroLivro">Nome Genero:</label>
                        <input type="text" class="form-control" id="GeneroLivro" required placeholder="Nome do Genero">
                    </div>
                    <button type="submit" class="btn btn-success">Cadastrar</button>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            carregarListaGeneros();

        });
        function carregarListaGeneros() {
            fetch('http://localhost:8080/generos')
                .then(response => response.json())
                .then(generos => {
                    const tabelaLista = document.getElementById('tabela_lista').getElementsByTagName('tbody')[0];
                    tabelaLista.innerHTML = '';
                    generos.forEach(genero => {
                        const row = tabelaLista.insertRow();
                        row.insertCell(0).textContent = genero.idGenero;
                        row.insertCell(1).textContent = genero.generoLivro;
                        
                        //Botao Editar

                        const cellEditar = document.createElement('td');
                        const btnEditar = document.createElement('button');
                        btnEditar.textContent = 'Editar';
                        btnEditar.className = 'btn btn-secondary';
                        btnEditar.onclick = function () {
                            editarGenero(event, genero.idGenero);
                        };
                        cellEditar.appendChild(btnEditar);
                        row.appendChild(cellEditar);

                        //Botao excluir
                        const cellExcluir = document.createElement('td');
                        const btnExcluir = document.createElement('button');
                        btnExcluir.textContent = 'Excluir';
                        btnExcluir.className = 'btn btn-danger';
                        btnExcluir.onclick = function () {
                            excluirGenero(genero.idGenero);
                        };
                        cellExcluir.appendChild(btnExcluir);
                        row.appendChild(cellExcluir);

                    });
                })
                .catch(error => console.error('Erro ao carregar lista:', error));
        }

        function carregarGeneroNome() {
            const busca = document.getElementById('pesquisa').value;
            const url = `http://localhost:8080/generos/genero/${busca}`
            const requestOptions = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
            };
            fetch(url, requestOptions)
                .then(response => response.json())
                .then(generos => {
                    const tabelaLista = document.getElementById('tabela_lista').getElementsByTagName('tbody')[0];
                    tabelaLista.innerHTML = '';
                    generos.forEach(genero => {
                        const row = tabelaLista.insertRow();
                        row.insertCell(0).textContent = genero.idGenero;
                        row.insertCell(1).textContent = genero.generoLivro;

                         //Botao Editar

                        const cellEditar = document.createElement('td');
                        const btnEditar = document.createElement('button');
                        btnEditar.textContent = 'Editar';
                        btnEditar.className = 'btn btn-secondary';
                        btnEditar.onclick = function () {
                            editarGenero(event, genero.idGenero);
                        };
                        cellEditar.appendChild(btnEditar);
                        row.appendChild(cellEditar);

                        // Botão Excluir
                        const cellExcluir = document.createElement('td');
                        const btnExcluir = document.createElement('button');
                        btnExcluir.textContent = 'Excluir';
                        btnExcluir.className = 'btn btn-danger';
                        btnExcluir.onclick = () => excluirGenero(genero.idGenero); 
                        cellExcluir.appendChild(btnExcluir);
                        row.appendChild(cellExcluir);
                    });
                })
                .catch(error => console.error('Erro ao buscar generos:', error))
        }


        // Função para adicionar um genero
        const formCadastro = document.getElementById('form_cadastro');
        formCadastro.addEventListener('submit', async function (event) {
            event.preventDefault();
            const data = {
                generoLivro: document.getElementById('GeneroLivro').value
            };
            fetch('http://localhost:8080/generos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.text())
                .then(data => {
                    alert("Genero Adicionado");
                    carregarListaGeneros();
                    formCadastro.reset();
                })
                .catch(error => console.error('Erro ao cadastrar Genero:', error));
        });

        //Função EDITAR Genero
        function editarGenero(event, id) {
            const button = event.target;
            const linha = button.closest('tr');
            const cells = linha.getElementsByTagName('td');

            for (let i = 1; i < cells.length - 2; i++) {
                const Valor = cells[i].textContent.trim();
                let input = document.createElement('input');
                input.type = 'text';
                input.value = Valor;
                input.className = 'textArea';
                cells[i].textContent = '';
                cells[i].appendChild(input);
            }

            const salvarButton = document.createElement('button');
            salvarButton.textContent = 'Salvar';
            salvarButton.className = 'btn btn-primary';
            salvarButton.onclick = function () {
                salvarEdicao(linha, id);
            };

            const cancelarButton = document.createElement('button');
            cancelarButton.textContent = 'Cancelar';
            cancelarButton.className = 'btn btn-danger';
            cancelarButton.onclick = function () {
                tabela.classList.remove('edit')
                carregarListaGeneros();
            };

            cells[cells.length - 1].innerHTML = '';
            cells[cells.length - 1].appendChild(cancelarButton);

            cells[cells.length - 2].innerHTML = '';
            cells[cells.length - 2].appendChild(salvarButton);

            const tabela = document.getElementsByClassName('tab-content')[0];
            tabela.classList.add('edit');

            const textAreas = document.getElementsByClassName('textArea');
            for (let i = 0; i < textAreas.length; i++) {
                textAreas[i].addEventListener('focus', () => {
                    textAreas[i].classList.add('expanded');
                });

                textAreas[i].addEventListener('blur', () => {
                    textAreas[i].classList.remove('expanded');
                });
            }
        }

        //Função salvar edição
        async function salvarEdicao(linha, id) {
            try {
                const inputs = linha.getElementsByTagName('input');
                const data = {
                    generoLivro: inputs[0].value.trim(),
                };
                const url = `http://localhost:8080/generos/${id}`;
                const requestOptions = {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                };
                fetch(url, requestOptions)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Falha ao atualizar o Genero. Código de status: ${response.status}`);
                        }
                        Swal.fire({
                            icon: 'success',
                            title: 'Sucesso',
                            text: 'O Genero foi atualizado com sucesso.'
                        });
                        carregarListaGeneros();
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: 'Erro ao tentar atualizar o Genero.'
                        });
                        console.error('Erro ao tentar atualizar o Genero:', error);
                    });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Atenção',
                    text: `Dados Invalidos Ou Vazios, Error: ${error.message}`
                });
                console.error(error);
            }
        }

        // Função pra excluir Genero
        function excluirGenero(id) {
            const url = `http://localhost:8080/generos/${id}`;
            const requestOptions = {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            Swal.fire({
                title: 'Tem certeza?',
                text: 'Esta ação não pode ser revertida!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, finalizar!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(url, requestOptions)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Falha ao excluir o genero. Código de status: ${response.status}`);
                            }

                            Swal.fire({
                                icon: 'success',
                                title: 'Atenção',
                                text: 'O Genero foi excluído com sucesso.'
                            });
                            carregarListaGeneros();
                        })
                        .catch(error => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Atenção',
                                text: 'Erro ao tentar excluir o Genero.'
                            });
                            carregarListaGeneros();
                        });
                }
            });
        }

        document.getElementById('buttonPesquisar').onclick = function () {
            carregarGeneroNome();
        };
        document.getElementById('buttonApagar').onclick = function () {
            carregarListaGeneros();
            document.getElementById('pesquisa').value = "";
        };

    </script>
</body>

</html>